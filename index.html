    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>THE $2 TRILLION MARKET CAP CLUB</title>
        <link rel="stylesheet" href="styles.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
        <script>
            console.log("Head script loaded");
            window.addEventListener('load', function() {
                console.log("Window loaded");
                console.log("renderD3Video is defined:", typeof window.renderD3Video === "function");
                console.log("chart is defined:", typeof window.chart !== "undefined");
                console.log("data is defined:", typeof data !== "undefined");
                console.log("createChart is defined:", typeof createChart === "function");
                console.log("startAnimation is defined:", typeof startAnimation === "function");
                console.log("URL includes 'render-d3-video':", document.URL.includes('render-d3-video'));
            });
        </script>
    </head>
    <body>
        <div id="chartContainer">
            <h1 id="chartTitle">THE $2 TRILLION MARKET CAP CLUB</h1>
            <div id="chartLegend"></div>
            <div id="yAxisTitle">Market capitalization (billions usd)</div>
            <canvas id="marketCapChart"></canvas>
            <div id="xAxisTitle">Year</div>
            <div id="currentDate"></div>
        </div>
        <div id="finalRankingContainer">
            <h2>Ranking</h2>
            <div id="finalRanking"></div>
        </div>
        <div id="buttonContainer">
            <button id="animateButton">Animate</button>
        </div>
        <script>
            const companies = [
                { name: 'Apple', file: 'aapl_market_cap.json', color: 'rgba(255, 99, 132, 1)', logo: 'Apple_logo_white.svg' },
                { name: 'Amazon', file: 'amzn_market_cap.json', color: 'rgba(255, 159, 64, 1)', logo: 'Amazon_logo.png' },
                { name: 'Google', file: 'googl_market_cap.json', color: 'rgba(75, 192, 192, 1)', logo: 'Google__G__logo.svg'},
                { name: 'Microsoft', file: 'msft_market_cap.json', color: 'rgba(54, 162, 235, 1)', logo: 'Microsoft_logo.svg' },
                { name: 'NVIDIA', file: 'nvidia_market_cap.json', color: 'rgba(153, 102, 255, 1)', logo: 'Nvidia_logo.svg' }
            ];
            const isMobile = window.innerWidth <= 428;
            const totalDuration = 31000;
            let animationId;
            let startTime;
            let data;
            let currentDataIndex = 0;
            window.renderD3Video = function({ width, height }) {
            console.log("renderD3Video called with width:", width, "height:", height);
            return new Promise(resolve => {
                setTimeout(() => {
                    const chartContainer = document.getElementById('chartContainer');
                    if (chartContainer) {
                        chartContainer.style.width = `${width}px`;
                        chartContainer.style.height = `${height}px`;
                    } else {
                        console.error('chartContainer not found');
                    }
                    
                    const canvas = document.getElementById('marketCapChart');
                    if (canvas) {
                        canvas.width = width + 10;
                        canvas.height = height;
                    } else {
                        console.error('marketCapChart canvas not found');
                    }
                    
                    if (window.chart && typeof window.chart.resize === 'function') {
                        window.chart.resize();
                    } else {
                        console.error('window.chart not found or resize is not a function');
                    }
                    
                    console.log("renderD3Video completed");
                    resolve();
                }, 1000);
            });
        };
            // Ajoutez ce code juste après la définition de window.renderD3Video
            console.log("renderD3Video is defined:", typeof window.renderD3Video === "function");
            async function loadData() {
                const dataPromises = companies.map(company => 
                    fetch(company.file).then(response => response.json())
                );
                const allData = await Promise.all(dataPromises);
                const processData = (data) => data
                    .filter(item => new Date(item.x).getFullYear() >= 2010) // Filtre les données à partir de 2014
                    .map(item => ({
                        x: new Date(item.x),
                        y: item.y / 1e9  // Convert to billions
                    }));
                const processedData = allData.map(processData);
                const startDate = new Date(Math.min(...processedData.flatMap(data => data.map(item => item.x.getTime()))));
                return Object.fromEntries(companies.map((company, index) => [
                    company.name,
                    processedData[index]
                ]));
            }
            async function createChart() {
        const data = await loadData();
        const ctx = document.getElementById('marketCapChart').getContext('2d');
        const maxDataPoints = Math.max(...Object.values(data).map(d => d.length));
        console.log("Max data points:", maxDataPoints);
        const delayBetweenPoints = Math.max(20, totalDuration / maxDataPoints);
        let currentDataIndex = 0;
        
        const animation = {
            x: {
                type: 'number',
                easing: 'linear',
                duration: delayBetweenPoints,
                from: NaN,
                delay(ctx) {
                    if (ctx.type !== 'data' || ctx.xStarted) {
                        return 0;
                    }
                    ctx.xStarted = true;
                    return ctx.index * delayBetweenPoints;
                }
            },
            y: {
                type: 'number',
                easing: 'linear',
                duration: delayBetweenPoints,
                from: NaN,
                delay(ctx) {
                    if (ctx.type !== 'data' || ctx.yStarted) {
                        return 0;
                    }
                    ctx.yStarted = true;
                    return ctx.index * delayBetweenPoints;
                }
            }
        };

        const chartConfig = {
            type: 'line',
            data: {
                datasets: companies.map(company => ({
                    label: company.name,
                    data: [data[company.name][0]],
                    borderColor: company.color,
                    backgroundColor: company.color,
                    borderWidth: isMobile ? 1 : 2,
                    pointRadius: 0,
                    fill: false
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation,
                interaction: {
                    intersect: false
                },
                layout: {
                    padding: {
                        top: isMobile ? 10 : 20,
                        right: isMobile ? 10 : 40,
                        bottom: isMobile ? 60 : 10,
                        left: isMobile ? 15 : 40
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'year' },
                        title: {
                            display: false,
                        },
                        ticks: {
                            font: {
                                size: isMobile ? 8 : 12
                            },
                            maxRotation: isMobile ? 45 : 0,
                            autoSkip: true,
                            maxTicksLimit: isMobile ? 5 : 10,
                            
                            callback: function(value, index, values) {
                                // Afficher uniquement les années jusqu'à la dernière année réelle
                                const year = new Date(value).getFullYear();
                                const maxYear = Math.max(...Object.values(data).flatMap(d => d.map(item => new Date(item.x).getFullYear())));
                                return year <= maxYear ? year.toString() : '';
                            }
                        },
                        grid: { 
                            display: !isMobile 
                        }
                    },
                    y: {
                        title: {
                            display: false
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return '$' + Math.round(value) + (isMobile ? '' : 'B');
                            },
                            font: {
                                size: isMobile ? 8 : 12
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            lineWidth: isMobile ? 0.5 : 1
                        }
                    },
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    zoom: {
                        zoom: {
                            wheel: { enabled: !isMobile },
                            pinch: { enabled: isMobile },
                            mode: 'xy'
                        },
                        pan: { enabled: true, mode: 'xy' }
                    },
                    tooltip: {
                        enabled: !isMobile
                    },
                    annotation: {
                        annotations: Object.fromEntries(companies.map(company => [
                            `${company.name}Value`,
                            {
                                type: 'label',
                                xValue: data[company.name][0].x,
                                yValue: data[company.name][0].y,
                                content: isMobile ? company.name : `${company.name}: $${data[company.name][0].y.toFixed(2)}B`,
                                backgroundColor: company.color,
                                color: 'white',
                                padding: isMobile ? 2 : 6,
                                font: {
                                    size: isMobile ? 8 : 12
                                },
                                borderRadius: isMobile ? 2 : 4,
                                xAdjust: 50,
                                yAdjust: 0,
                                textAlign: 'left',
                                xAlign: 'left',
                                yAlign: 'center',
                                callout: {
                                    display: true,
                                    borderColor: company.color,
                                    borderWidth: 2,
                                    side: 'left',
                                    length: 3
                                }
                            }
                        ]))
                    }
                }
            }
        };

        window.chart = new Chart(ctx, chartConfig);
        createCustomLegend(window.chart);

        return window.chart;
    }
            
            function animate(timestamp) {
        if (!startTime) startTime = timestamp;
        const elapsed = timestamp - startTime;
        const progress = Math.min(elapsed / totalDuration, 1);
        
        currentDataIndex = Math.floor(progress * (Math.max(...Object.values(data).map(d => d.length)) - 1));
        
        if (currentDataIndex < Math.max(...Object.values(data).map(d => d.length)) - 1) {
            companies.forEach((company, index) => {
                const currentData = data[company.name][Math.min(currentDataIndex, data[company.name].length - 1)];
                window.chart.data.datasets[index].data = data[company.name].slice(0, currentDataIndex + 1);
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = `${company.name}: $${currentData.y.toFixed(2)}B`;
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = currentData.x;
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = currentData.y;
            });

            const visibleData = window.chart.data.datasets.flatMap(dataset => dataset.data);
            const maxValue = Math.max(...visibleData.map(d => d.y));
            window.chart.options.scales.y.max = maxValue * 1.1;

            const currentDate = new Date(Math.max(...companies.map(company => 
                data[company.name][Math.min(currentDataIndex, data[company.name].length - 1)].x
            )));

            const oldestDate = new Date(Math.min(...visibleData.map(d => d.x)));
            const range = currentDate - oldestDate;
            window.chart.options.scales.x.min = oldestDate;
            window.chart.options.scales.x.max = new Date(currentDate.getTime() + range * 0.70);
            document.getElementById('currentDate').textContent = moment(currentDate).format('MMMM D, YYYY');

            window.chart.update('none');

            if (progress < 1) {
                animationId = requestAnimationFrame(animate);
            }
        } else {
            // Animation terminée
            const finalValues = companies.map(company => ({
                name: company.name,
                logo: company.logo,
                value: data[company.name][data[company.name].length - 1].y
            }));
            finalValues.sort((a, b) => b.value - a.value)
            // Aligner les labels à la fin de l'animation
            const maxX = Math.max(...companies.map(company => 
                data[company.name][data[company.name].length - 1].x
            ));
             // Ajouter un décalage à la date maximale (par exemple, 6 mois)
            const alignmentX = new Date(maxX.getTime() + 15* 1000 * 60 * 60 * 24 * 180); // 180 jours = environ 6 mois
            
            companies.forEach((company, index) => {
                const finalData = data[company.name][data[company.name].length - 1];
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = alignmentX;
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = finalData.y;
                window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = `${company.name}: $${finalData.y.toFixed(2)}B`;
            });
            const rankingHtml = finalValues.map((company, index) => 
                `<div class="rank-item">
                    <span class="rank">${index + 1}</span>
                    <img src="${company.logo}" alt="${company.name}" class="company-logo">
                    <span class="value">$${company.value.toFixed(2)}B</span>
                </div>`
            ).join('');
            document.getElementById('finalRanking').innerHTML = rankingHtml;
            document.getElementById('finalRankingContainer').style.display = 'block';
            // Ajuster l'échelle X pour s'assurer que tous les labels sont visibles
           // Ajuster l'échelle X pour s'assurer que tous les labels sont visibles
        window.chart.options.scales.x.max = new Date(alignmentX.getTime() + 1000 * 60 * 60 * 24 * 180); // Ajouter 6 mois de plus
        window.chart.update();
        }
    }
            
            function createCustomLegend(chart) {
                const legendContainer = document.getElementById('chartLegend');
                legendContainer.innerHTML = chart.data.datasets.map(dataset => 
                    `<span style="display:inline-block; margin-right:10px; font-family: 'Neue Haas Display', Helvetica, Arial, sans-serif; color: #ffffff;">
                    <span style="background-color:${dataset.borderColor}; 
                                    width:10px; height:10px; display:inline-block; 
                                    margin-right:5px;"></span>
                    ${dataset.label}
                    </span>`
                ).join('');
            }
            // ... (previous code remains the same)
            function startAnimation() {
        if (!data || !window.chart) {
            console.error('Data or chart not initialized');
            return;
        }
        
        cancelAnimationFrame(animationId);
        startTime = null;
        currentDataIndex = 0;
        companies.forEach((company, index) => {
            window.chart.data.datasets[index].data = [data[company.name][0]];
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = isMobile ? company.name : `${company.name}: $${data[company.name][0].y.toFixed(2)}B`;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = data[company.name][0].x;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = data[company.name][0].y;
        });
        window.chart.options.scales.y.max = Math.max(...Object.values(data).map(d => d[0].y)) * 1.1;
        window.chart.options.scales.x.min = Object.values(data)[0][0].x;
        window.chart.options.scales.x.max = moment(Object.values(data)[0][0].x).add(isMobile ? 1 : 8, 'years').toDate();
        document.getElementById('currentDate').textContent = moment(Object.values(data)[0][0].x).format(isMobile ? 'MM/DD/YY' : 'MMM D, YYYY');
        document.getElementById('finalRankingContainer').style.display = 'none';
        window.chart.update();
        
        animationId = requestAnimationFrame(animate);
        currentDataIndex = 0;
        companies.forEach((company, index) => {
            window.chart.data.datasets[index].data = [data[company.name][0]];
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = isMobile ? company.name : `${company.name}: $${data[company.name][0].y.toFixed(2)}B`;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = data[company.name][0].x;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = data[company.name][0].y;
        });
        window.chart.options.scales.y.max = Math.max(...Object.values(data).map(d => d[0].y)) * 1.1;
        window.chart.options.scales.x.min = Object.values(data)[0][0].x;
        window.chart.options.scales.x.max = moment(Object.values(data)[0][0].x).add(isMobile ? 1 : 8, 'years').toDate();
        document.getElementById('currentDate').textContent = moment(Object.values(data)[0][0].x).format(isMobile ? 'MM/DD/YY' : 'MMM D, YYYY');
        document.getElementById('finalRankingContainer').style.display = 'none';
        window.chart.update();
        
        if (window.currentTime !== undefined) {
            requestAnimationFrame(() => window.chart.draw());
        }
    }
            // À la fin de votre script, après toutes les définitions de fonctions :
            console.log("Script started");
            async function initializeChart() {
                console.log("initializeChart started");
                data = await loadData();
                console.log("Data loaded");
                window.chart = await createChart();
                console.log("Chart created");
                
                if (window.currentTime !== undefined) {
                    console.log("Calling renderD3Video");
                    await window.renderD3Video({ width: 1920, height: 1080 });
                    console.log("renderD3Video completed");
                    startAnimation();
                }
                console.log("initializeChart completed");
            }
            document.addEventListener('DOMContentLoaded', () => {
                console.log("DOMContentLoaded event fired");
                initializeChart();
            });
            document.getElementById('animateButton').addEventListener('click', startAnimation);
            console.log("Script ended");
        </script>
    
    </body>
    </html>
