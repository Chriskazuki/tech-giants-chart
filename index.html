<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>THE $2 TRILLION MARKET CAP CLUB</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script>
        console.log("Head script loaded");
        window.addEventListener('load', function () {
            console.log("Window loaded");
            console.log("renderD3Video is defined:", typeof window.renderD3Video === "function");
            console.log("chart is defined:", typeof window.chart !== "undefined");
            console.log("data is defined:", typeof data !== "undefined");
            console.log("createChart is defined:", typeof createChart === "function");
            console.log("startAnimation is defined:", typeof startAnimation === "function");
            console.log("URL includes 'render-d3-video':", document.URL.includes('render-d3-video'));
        });
    </script>
</head>

<body>
    <div id="chartContainer">
        <h1 id="chartTitle">THE $2 TRILLION MARKET CAP CLUB</h1>
        <div id="chartLegend"></div>
        <div id="yAxisTitle">Market capitalization (billions usd)</div>
        <canvas id="marketCapChart"></canvas>
        <div id="xAxisTitle">Year</div>
        <div id="currentDate"></div>
    </div>
    <div id="finalRankingContainer">
        <h2>Ranking</h2>
        <div id="finalRanking"></div>
    </div>
    <div id="buttonContainer">
        <button id="animateButton">Animate</button>
    </div>
    <script>
        const companies = [
            { name: 'Apple', file: 'aapl_market_cap.json', color: 'rgba(255, 99, 132, 1)', logo: 'Apple_logo_white.svg' },
            { name: 'Amazon', file: 'amzn_market_cap.json', color: 'rgba(255, 159, 64, 1)', logo: 'Amazon_logo.png' },
            { name: 'Google', file: 'googl_market_cap.json', color: 'rgba(75, 192, 192, 1)', logo: 'Google__G__logo.svg' },
            { name: 'Microsoft', file: 'msft_market_cap.json', color: 'rgba(54, 162, 235, 1)', logo: 'Microsoft_logo.svg' },
            { name: 'NVIDIA', file: 'nvidia_market_cap.json', color: 'rgba(153, 102, 255, 1)', logo: 'Nvidia_logo.svg' }
        ];
        const isMobile = window.innerWidth <= 428;
        const totalDuration = 31000;
        let animationId;
        let startTime;
        let data;
        let currentDataIndex = 0;
        window.renderD3Video = function ({ width, height }) {
            console.log("renderD3Video called with width:", width, "height:", height);
            return new Promise(resolve => {
                setTimeout(() => {
                    const chartContainer = document.getElementById('chartContainer');
                    if (chartContainer) {
                        chartContainer.style.width = `${width}px`;
                        chartContainer.style.height = `${height}px`;
                    } else {
                        console.error('chartContainer not found');
                    }

                    const canvas = document.getElementById('marketCapChart');
                    if (canvas) {
                        canvas.width = width + 10;
                        canvas.height = height;
                    } else {
                        console.error('marketCapChart canvas not found');
                    }

                    if (window.chart && typeof window.chart.resize === 'function') {
                        window.chart.resize();
                    } else {
                        console.error('window.chart not found or resize is not a function');
                    }

                    console.log("renderD3Video completed");
                    resolve();
                }, 1000);
            });
        };
        // Ajoutez ce code juste après la définition de window.renderD3Video
        console.log("renderD3Video is defined:", typeof window.renderD3Video === "function");
        async function loadData() {
            const dataPromises = companies.map(company =>
                fetch(company.file).then(response => response.json())
            );
            const allData = await Promise.all(dataPromises);
            const processData = (data) => data
                .filter(item => new Date(item.x).getFullYear() >= 2010) // Filtre les données à partir de 2014
                .map(item => ({
                    x: new Date(item.x),
                    y: item.y / 1e9  // Convert to billions
                }));
            const processedData = allData.map(processData);
            const startDate = new Date(Math.min(...processedData.flatMap(data => data.map(item => item.x.getTime()))));
            return Object.fromEntries(companies.map((company, index) => [
                company.name,
                processedData[index]
            ]));
        }
        async function createChart() {
            const data = await loadData();
            const ctx = document.getElementById('marketCapChart').getContext('2d');

            const allDates = Object.values(data).flatMap(d => d.map(item => item.x));
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            
            const startYear = minDate.getFullYear();
            const endYear = maxDate.getFullYear();
            const numberOfTicks = endYear - startYear + 1;
            const yearStep = Math.ceil((endYear - startYear) / (numberOfTicks - 1));
            const maxDataPoints = Math.max(...Object.values(data).map(d => d.length));
            const delayBetweenPoints = Math.max(20, totalDuration / maxDataPoints);


            const animation = {
                x: {
                    type: 'number',
                    easing: 'linear',
                    duration: delayBetweenPoints,
                    from: NaN,
                    delay(ctx) {
                        if (ctx.type !== 'data' || ctx.xStarted) {
                            return 0;
                        }
                        ctx.xStarted = true;
                        return ctx.index * delayBetweenPoints;
                    }
                },
                y: {
                    type: 'number',
                    easing: 'linear',
                    duration: delayBetweenPoints,
                    from: NaN,
                    delay(ctx) {
                        if (ctx.type !== 'data' || ctx.yStarted) {
                            return 0;
                        }
                        ctx.yStarted = true;
                        return ctx.index * delayBetweenPoints;
                    }
                }
            };
            const chartConfig = {
                type: 'line',
                data: {
                    datasets: companies.map(company => ({
                        label: company.name,
                        data: [data[company.name][0]],
                        borderColor: company.color,
                        backgroundColor: company.color,
                        borderWidth: isMobile ? 1 : 2,
                        pointRadius: 0,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation,
                    interaction: {
                        intersect: false
                    },
                    layout: {
                        padding: {
                            top: isMobile ? 10 : 20,
                            right: isMobile ? 10 : 5,
                            bottom: isMobile ? 60 : 10,
                            left: isMobile ? 15 : 40
                        }
                    },
                    scales: {
                        x: {
    type: 'time',
    time: {
        unit: 'year',
        displayFormats: {
            year: 'YYYY'
        }
    },
    min: new Date(2010, 0, 1),
    max: new Date(2024, 11, 31),
    ticks: {
        source: 'auto',
        autoSkip: false,
        maxTicksLimit: 3,
        maxRotation: isMobile ? 45 : 0,
        font: {
            size: isMobile ? 8 : 12
        },
        callback: function(value, index, values) {
    const year = new Date(value).getFullYear();
    const maxDataYear = getMaxDate(data).getFullYear();
    if (year > maxDataYear) {
        return null; // Ne pas afficher les années futures
    }
    if (index === 0 || index === values.length - 1 || index % 2 === 0) {
        return year.toString();
    }
    return null;
}
    },
    grid: {
        display: !isMobile
    }
},
                        y: {
                            title: {
                                display: false
                            },
                            ticks: {
    source: 'data',
    autoSkip: false,
    callback: function(value, index, values) {
            return '$' + value.toFixed(0) + 'B';
        }
},
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                lineWidth: isMobile ? 0.5 : 1
                            }
                        },
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: !isMobile },
                                pinch: { enabled: isMobile },
                                mode: 'xy'
                            },
                            pan: { enabled: true, mode: 'xy'}
                        },
                        tooltip: {
                            enabled: !isMobile
                        },
                        annotation: {
                            annotations: Object.fromEntries(companies.map(company => [
                                `${company.name}Value`,
                                {
                                    type: 'label',
                                    xValue: data[company.name][0].x,
                                    yValue: data[company.name][0].y,
                                    content: isMobile ? company.name : `${company.name}: $${data[company.name][0].y.toFixed(2)}B`,
                                    backgroundColor: company.color,
                                    color: 'white',
                                    padding: isMobile ? 2 : 6,
                                    font: {
                                        size: isMobile ? 8 : 12
                                    },lastDataPoint: {
                                    type: 'label',
                                    xValue: getMaxDate(data),
                                    yValue: 'top',
                                    content: 'Last data point',
                                    font: {
                                        size: 10,
                                        style: 'italic'
                                    },
                                    color: 'rgba(255, 255, 255, 0.5)',
                                    xAdjust: -30,
                                    yAdjust: 10
                                        },
                                    borderRadius: isMobile ? 2 : 4,
                                    xAdjust: 50,
                                    yAdjust: 0,
                                    textAlign: 'left',
                                    xAlign: 'left',
                                    yAlign: 'center',
                                    callout: {
                                        display: true,
                                        borderColor: company.color,
                                        borderWidth: 2,
                                        side: 'left',
                                        length: 3
                                    }
                                }
                            ]))
                        }
                    }
                }
            };
            const maxDataDate = getMaxDate(data);
            const extraMonths = 12; // Ajoutez 6 mois d'espace supplémentaire
            chartConfig.options.scales.x.max = new Date(maxDataDate.getFullYear(),
            maxDataDate.getMonth() + extraMonths, 1);

            window.chart = new Chart(ctx, chartConfig);
            createCustomLegend(window.chart);
            return window.chart;
        }

function showFinalRanking() {
    const finalValues = companies.map(company => ({
        name: company.name,
        logo: company.logo,
        value: data[company.name][data[company.name].length - 1].y
    }));
    finalValues.sort((a, b) => b.value - a.value);
    const rankingHtml = finalValues.map((company, index) =>
        `<div class="rank-item">
            <span class="rank">${index + 1}</span>
            <img src="${company.logo}" alt="${company.name}" class="company-logo">
            <span class="company-name">${company.name}</span>
            <span class="value">$${company.value.toFixed(2)}B</span>
         </div>`
    ).join('');
    document.getElementById('finalRanking').innerHTML = rankingHtml;
    document.getElementById('finalRankingContainer').style.display = 'block';
}

function alignAnnotations() {
    const finalValues = companies.map(company => ({
        name: company.name,
        value: data[company.name][data[company.name].length - 1].y
    }));
    finalValues.sort((a, b) => b.value - a.value);

    const maxDate = getMaxDate(data);
    const xPosition = maxDate.getTime();
    
    finalValues.forEach((company, index) => {
        const annotation = window.chart.options.plugins.annotation.annotations[`${company.name}Value`];
        annotation.xValue = xPosition;
        annotation.yValue = company.value;
        annotation.yAdjust = index * 30; // Adjust vertical spacing between labels
    });

    window.chart.update('none');
}

        
        function getMaxDate(data) {
    return new Date(Math.max(...Object.values(data).flatMap(d => d.map(item => item.x.getTime()))));
}


function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const progress = Math.min(elapsed / totalDuration, 1);

    currentDataIndex = Math.floor(progress * (Math.max(...Object.values(data).map(d => d.length)) - 1));

    if (progress < 1) {
        companies.forEach((company, index) => {
            const currentData = data[company.name][Math.min(currentDataIndex, data[company.name].length - 1)];
            window.chart.data.datasets[index].data = data[company.name].slice(0, currentDataIndex + 1);
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = isMobile ? company.name : `${company.name}: $${currentData.y.toFixed(2)}B`;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = currentData.x;
            window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = currentData.y;
        });

        const currentDate = new Date(Math.max(...companies.map(company =>
            data[company.name][Math.min(currentDataIndex, data[company.name].length - 1)].x
        )));

        const maxDataDate = getMaxDate(data);
        if (currentDate <= maxDataDate) {
            document.getElementById('currentDate').textContent = moment(currentDate).format('MMMM D, YYYY');
            
            // Ajuster l'échelle X pour avoir de l'espace supplémentaire
            const extraMonths = 100; // Ajoutez 6 mois d'espace supplémentaire
            window.chart.options.scales.x.max = new Date(maxDataDate.getFullYear(), maxDataDate.getMonth() + extraMonths, 1);
            
            window.chart.update('none');
            animationId = requestAnimationFrame(animate);
        } else {
            alignAnnotations();
            showFinalRanking();
        }
    } else {
        alignAnnotations();
        showFinalRanking();
    }
}

function showFinalRanking() {
    const finalValues = companies.map(company => ({
        name: company.name,
        logo: company.logo,
        value: data[company.name][data[company.name].length - 1].y
    }));
    finalValues.sort((a, b) => b.value - a.value);
    const rankingHtml = finalValues.map((company, index) =>
        `<div class="rank-item">
            <span class="rank">${index + 1}</span>
            <img src="${company.logo}" alt="${company.name}" class="company-logo" title="${company.name}">
            <span class="value">$${company.value.toFixed(2)}B</span>
         </div>`
    ).join('');
    document.getElementById('finalRanking').innerHTML = rankingHtml;
    document.getElementById('finalRankingContainer').style.display = 'block';
}
        function createCustomLegend(chart) {
            const legendContainer = document.getElementById('chartLegend');
            legendContainer.innerHTML = chart.data.datasets.map(dataset =>
                `<span style="display:inline-block; margin-right:10px; font-family: 'Neue Haas Display', Helvetica, Arial, sans-serif; color: #ffffff;">
                <span style="background-color:${dataset.borderColor}; 
                                width:10px; height:10px; display:inline-block; 
                                margin-right:5px;"></span>
                ${dataset.label}
                </span>`
            ).join('');
        }
        // ... (previous code remains the same)
        function startAnimation() {
    if (!data || !window.chart) {
        console.error('Data or chart not initialized');
        return;
    }

    cancelAnimationFrame(animationId);
    startTime = null;
    currentDataIndex = 0;
    companies.forEach((company, index) => {
        window.chart.data.datasets[index].data = [data[company.name][0]];
        window.chart.options.plugins.annotation.annotations[`${company.name}Value`].content = isMobile ? company.name : `${company.name}: $${data[company.name][0].y.toFixed(2)}B`;
        window.chart.options.plugins.annotation.annotations[`${company.name}Value`].xValue = data[company.name][0].x;
        window.chart.options.plugins.annotation.annotations[`${company.name}Value`].yValue = data[company.name][0].y;
    });
    
    document.getElementById('currentDate').textContent = moment(Object.values(data)[0][0].x).format('MMMM D, YYYY');
    document.getElementById('finalRankingContainer').style.display = 'none';
    
    window.chart.update('none');
    animationId = requestAnimationFrame(animate);
}


        // À la fin de votre script, après toutes les définitions de fonctions :
        console.log("Script started");
        async function initializeChart() {
            console.log("initializeChart started");
            data = await loadData();
            console.log("Data loaded");
            window.chart = await createChart();
            console.log("Chart created");

            if (window.currentTime !== undefined) {
                console.log("Calling renderD3Video");
                await window.renderD3Video({ width: 1920, height: 1080 });
                console.log("renderD3Video completed");
                startAnimation();
            }
            console.log("initializeChart completed");
        }
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired");
            initializeChart();
        });
        document.getElementById('animateButton').addEventListener('click', startAnimation);
        console.log("Script ended");
    </script>

</body>

</html>
